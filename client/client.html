<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Springer Builder</title>
    <link rel="stylesheet" type="text/css" href="/style.css">

</head>

<body>
    <script>

        let JSONobject;
        //handles responses based on error code
        const handleResponse = async (response, form) => {
            const content = document.querySelector('#content');

            switch (response.status) {
                case 200:
                    content.innerHTML = '<b>Success</b>';
                    break;
                case 201:
                    content.innerHTML = `<b>Created</b>`;
                    break;
                case 204:
                    content.innerHTML = `<b>Updated</b>`;
                    break;
                case 400:
                    content.innerHTML = `<b>Bad Request</b>`;
                    break;
                case 404:
                    content.innerHTML = `<b>Resource Not Found</b>`;
                    break;
                default:
                    content.innerHTML = `Error code not implemented by client.`;
                    break;
            }

            const method = document.querySelector('#methodSelect');

            //checks if it is a get or post based on the value of the method
            if (method.value === 'get') {

                const urlField = document.querySelector('#urlField');

                if (form.method === 'post') {

                    response.text().then((responseText) => {
                        if (responseText == '') {
                            return false;
                        }
                        //console.log(responseText);
                        let parsedResponse = JSON.parse(responseText);
                        //console.log(parsedResponse);
                        content.innerHTML += `<p>${parsedResponse.message}</p>`;

                    });
                }
                else if (form.method === 'get') {

                    response.text().then((responseText) => {
                        let parsedResponse = JSON.parse(responseText);
                        let parsedBuild = JSON.stringify(parsedResponse.builds);
                        //console.log(parsedResponse);

                        if (urlField.value == "/getBuild") {
                            parsedBuild.forEach((person)=> {
                                content.innerHTML += `<p>${person.name}</p>`
                                content.innerHTML += `<p>${person.blaster}</p>`
                                content.innerHTML += `<p>${person.spring}</p>`
                            })

                            content.innerHTML += `<p>${parsedBuild}</p>`;
                        }
                        else if (urlField.value == "/notReal") {
                            content.innerHTML += `<p>${parsedResponse.message}</p>`;
                        }
                    });
                }
            }
        }

        const sendPOST = async (buildForm) => {
            const nameAction = buildForm.getAttribute('action');
            const nameMethod = buildForm.getAttribute('method');

            const nameField = buildForm.querySelector('#nameField');
            const blasterType = buildForm.querySelector('#blasterType');
            const barrelType = buildForm.querySelector('#barrelType');
            const springType = buildForm.querySelector('#springType');
            const additionalType = buildForm.querySelector('#additionalType');
            const fpsField = buildForm.querySelector('#fpsField');
            const priceField = buildForm.querySelector('#priceField');

            const formData = `name=${nameField.value}&blaster=${blasterType.value}&barrel=${barrelType.value}&spring=${springType.value}&additional=${additionalType.value}&fps=${fpsField.value}&price=${priceField.value}`;

            let response = await fetch(nameAction, {
                method: nameMethod,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                },
                body: formData,
            });

            handleResponse(response, buildForm);
        };

        const getPOST = async (viewForm) => {
            const nameMethod = viewForm.getAttribute('method');

            let response = await fetch(urlField.value, {
                method: nameMethod,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                },
            });

            handleResponse(response, viewForm);
        };

        function htmlFormatting() {

            let selected
            let string =
                `<label for="blaster">Blaster: </label>
                <select id='blasterType' name="blaster" onchange="handleOnChange(this.value)">`;

            for (let i = 0; i < JSONobject.blasters.length; i++) {
                string +=
                    `<option value="${JSONobject.blasters[i].blastername}">
                    ${JSONobject.blasters[i].blastername}
                    by ${JSONobject.blasters[i].blasterbrand}</option>`;
            };

            string += `</select>`;

            return string;
        }

        function handleOnChange(value) {

            document.querySelector

            console.log("Blaster Changed!");

            let index = 0;

            if(value === "Talon Claw T4"){
                index = 0;
            }

            if(value === "Nexus Pro"){
                index = 1;
            }

            if(value === "Harrier"){
                index = 2;
            }

            let string = `
            <label for="barrel">Barrel: </label>
            <select id='barrelType' name="barrel">`

            for (let i = 0; i < JSONobject.blasters[index].barrels.length; i++) {
                string +=
                    `<option value="${JSONobject.blasters[index].barrels[i].barrelname}">
                    ${JSONobject.blasters[index].barrels[i].barrelname}</option>`;
            }

            string += `</select> <br>`

            string += `<label for="spring">Spring: </label>
            <select id='springType' name="spring">`

            for (let i = 0; i < JSONobject.blasters[index].springs.length; i++) {
                string +=
                    `<option value="${JSONobject.blasters[index].springs[i].springname}">
                    ${JSONobject.blasters[index].springs[i].springname}</option>`;
            }

            string += `</select> <br>`

            string += `<label for="additional">Additional: </label>
            <select id='additionalType' name="additional">`

            for (let i = 0; i < JSONobject.blasters[index].additional.length; i++) {
                string +=
                    `<option value="${JSONobject.blasters[index].additional[i].additionalname}">
                    ${JSONobject.blasters[index].additional[i].additionalname}</option>`;
            }

            string += `</select> <br>
            <label for="fps">FPS Average: </label>
            <input id="fpsField" type="number" min = "0" name="fps" />
            <label for="price">Price (USD): </label>
            <input id="priceField" type="number" min = "0" name="price" />
            <input type="submit" value="Add Blaster" />`

            let form = document.querySelector("#details");
            form.innerHTML = string;
        }

        const PopulateBlasterData = async () => {
            const response = await fetch('/blasters.json');
            const dropdownData = await response.json();

            //console.log(dropdownData);

            let JSONstring = JSON.stringify(dropdownData);
            JSONobject = JSON.parse(JSONstring);

            //console.log(JSONobject);

            let form = document.querySelector("#buildForm");

            form.innerHTML += htmlFormatting();

            return JSONobject;
        }

        const init = () => {
            JSONobject = PopulateBlasterData();

            const buildForm = document.querySelector('#buildForm');
            const viewForm = document.querySelector('#viewForm');

            const addBuild = (e) => {
                e.preventDefault();
                sendPOST(buildForm);
                return false;
            }

            const getBuild = (e) => {
                e.preventDefault();
                getPOST(viewForm);
                return false;
            }

            buildForm.addEventListener('submit', addBuild);
            viewForm.addEventListener('submit', getBuild);
        };

        window.onload = init;

    </script>

    <section id="top">
        <h3>Create a Springer Build</h3>
        <form id="buildForm" action="/addBuild" method="post">
            <label for="name">Your Name: </label>
            <input id="nameField" type="text" name="name" />
            <div id = "details"></div>

        </form>
        <form id="viewForm" action="/getBuild" method="get">
            <select id='urlField'>
                <option value='/getBuild'>View builds</option>
                <option value='/notReal'>/notReal</option>
            </select>
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="View builds" />
        </form>
    </section>
    <section id="content">
    </section>

</body>

</html>